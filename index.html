<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>üéß Buscador de Audiolibros con Etiquetas</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéß</text></svg>">
    <style>
        :root {
            --primary: #3498db;
            --success: #27ae60;
            --danger: #e74c3c;
            --warning: #f39c12;
            --purple: #9b59b6;
            --dark: #2c3e50;
            --light: #f8f9fa;
            --gray: #7f8c8d;
            --border: #e9ecef;
            
            /* Colores de etiquetas predeterminadas */
            --tag-red: #e74c3c;
            --tag-purple: #9b59b6;
            --tag-green: #27ae60;
            --tag-blue: #3498db;
            --tag-orange: #f39c12;
            --tag-teal: #1abc9c;
            --tag-pink: #e84393;
            --tag-gray: #95a5a6;
            --tag-brown: #a1887f;
            --tag-indigo: #3f51b5;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header */
        .header {
            text-align: center;
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.15);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--purple));
        }
        
        .header h1 {
            color: var(--dark);
            font-size: 2.8em;
            margin-bottom: 10px;
            background: linear-gradient(90deg, var(--primary), var(--purple));
            -webkit-background-clip: text;
            background-clip: text;
            color: transparent;
            display: inline-block;
        }
        
        .header p {
            color: var(--gray);
            font-size: 1.2em;
            max-width: 800px;
            margin: 0 auto;
        }
        
        /* M√©todo selector */
        .method-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .method-btn {
            padding: 15px 30px;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 16px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
            justify-content: center;
        }
        
        .method-btn.active {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }
        
        .method-btn:hover:not(.active) {
            background: var(--light);
            transform: translateY(-2px);
        }
        
        /* Paneles de b√∫squeda */
        .search-panel {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            margin-bottom: 25px;
            animation: slideIn 0.5s ease;
        }
        
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .search-panel h2 {
            color: var(--dark);
            margin-bottom: 25px;
            text-align: center;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        /* Formulario de b√∫squeda */
        .search-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
            align-items: end;
        }
        
        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .input-group label {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9em;
        }
        
        .search-input {
            padding: 16px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: var(--light);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary);
            background: white;
            box-shadow: 0 0 0 4px rgba(52, 152, 219, 0.1);
        }
        
        .search-btn {
            padding: 16px 30px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            min-height: 56px;
        }
        
        .search-btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.3);
        }
        
        /* Botones r√°pidos */
        .quick-buttons {
            display: flex;
            gap: 12px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .quick-btn {
            padding: 12px 24px;
            background: var(--light);
            border: 2px solid var(--border);
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .quick-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        /* Controles */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: white;
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            flex-wrap: wrap;
            gap: 20px;
        }
        
        .filter-section {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .filter-group-label {
            font-weight: 600;
            color: var(--dark);
            font-size: 0.85em;
            padding-left: 5px;
        }
        
        .filter-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            background: var(--light);
            color: var(--dark);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .filter-btn.active {
            background: var(--primary);
            color: white;
        }
        
        .filter-btn.no-encontrados {
            background: #ffe6e6;
            color: var(--danger);
        }
        
        .filter-btn.no-encontrados.active {
            background: var(--danger);
            color: white;
        }
        
        /* Bot√≥n para borrar filtros */
        .clear-filters-btn {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .clear-filters-btn:hover {
            background: #5a6268;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        /* Botones de filtro de etiquetas */
        .tag-filter-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            position: relative;
            min-width: 120px;
            justify-content: center;
        }
        
        .tag-filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .tag-filter-btn.active {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .tag-filter-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.8);
        }
        
        .counter-section {
            display: flex;
            align-items: center;
            gap: 15px;
            flex-wrap: wrap;
        }
        
        .counter-badge {
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .counter-descargados {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }
        
        .counter-noencontrados {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }
        
        .counter-etiquetas {
            background: rgba(155, 89, 182, 0.1);
            color: var(--purple);
        }
        
        .action-btn {
            padding: 10px 20px;
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            min-height: 44px;
        }
        
        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }
        
        .export-btn { background: var(--success); }
        .export-btn:hover { background: #219653; }
        
        .backup-btn { background: var(--primary); }
        .backup-btn:hover { background: #2980b9; }
        
        .import-btn { background: var(--purple); }
        .import-btn:hover { background: #8e44ad; }
        
        .clear-btn { background: var(--danger); }
        .clear-btn:hover { background: #c0392b; }
        
        /* Gestor de etiqueta personalizadas */
        .tag-manager-btn {
            background: var(--warning);
            color: white;
        }
        
        .tag-manager-btn:hover {
            background: #e67e22;
        }
        
        .tag-manager-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .tag-manager-modal.show {
            opacity: 1;
            visibility: visible;
        }
        
        .tag-manager-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }
        
        .tag-manager-modal.show .tag-manager-content {
            transform: translateY(0);
        }
        
        .tag-manager-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--light);
        }
        
        .tag-manager-header h3 {
            color: var(--dark);
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: var(--gray);
            padding: 5px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-modal:hover {
            background: var(--light);
            color: var(--danger);
        }
        
        .custom-tags-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }
        
        .custom-tag-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: var(--light);
            border-radius: 12px;
            border-left: 5px solid;
        }
        
        .custom-tag-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .custom-tag-color {
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .custom-tag-name {
            font-weight: 600;
            color: var(--dark);
        }
        
        .custom-tag-actions {
            display: flex;
            gap: 10px;
        }
        
        .tag-action-btn {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            font-weight: 500;
        }
        
        .tag-edit-btn {
            background: var(--primary);
            color: white;
        }
        
        .tag-delete-btn {
            background: var(--danger);
            color: white;
        }
        
        .tag-action-btn:hover {
            opacity: 0.9;
        }
        
        .create-tag-form {
            background: var(--light);
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }
        
        .create-tag-form h4 {
            margin-bottom: 15px;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 100px;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .form-row input {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 14px;
        }
        
        .form-row input:focus {
            outline: none;
            border-color: var(--primary);
        }
        
        .color-preview {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            cursor: pointer;
            border: 2px solid var(--border);
        }
        
        .color-input {
            display: none;
        }
        
        .create-tag-btn {
            width: 100%;
            padding: 12px;
            background: var(--success);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .create-tag-btn:hover {
            background: #219653;
        }
        
        /* Estad√≠sticas */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s ease;
            position: relative;
            overflow: hidden;
        }
        
        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 5px;
            background: linear-gradient(90deg, var(--primary), var(--purple));
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: var(--gray);
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Grid de libros */
        .books-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 480px) {
            .books-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .welcome-message {
            grid-column: 1 / -1;
            text-align: center;
            background: white;
            padding: 50px;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
        }
        
        .welcome-message h3 {
            color: var(--dark);
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        
        .welcome-message p {
            color: var(--gray);
            margin-bottom: 15px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.8;
        }
        
        /* Tarjetas de libros */
        .book-card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            border: 3px solid transparent;
            animation: fadeIn 0.5s ease;
            overflow: hidden;
            min-height: 300px;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }
        
        .book-card:hover {
            transform: translateY(-10px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }
        
        .book-card.descargado {
            background: var(--light);
            border-color: #bdc3c7;
            opacity: 0.9;
        }
        
        .book-card.no-encontrado {
            background: #fff5f5;
            border-color: var(--danger);
            opacity: 0.9;
        }
        
        .book-card.descargado .book-title,
        .book-card.descargado .book-author {
            text-decoration: line-through;
            color: var(--gray);
        }
        
        .book-card.no-encontrado .book-title,
        .book-card.no-encontrado .book-author {
            color: var(--danger);
        }
        
        /* ETIQUETAS DE COLOR */
        .tag-indicator {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 25px;
            height: 25px;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }
        
        .tag-indicator:hover {
            transform: scale(1.2);
        }
        
        .tag-indicator.untagged {
            background: repeating-linear-gradient(
                45deg,
                #ccc,
                #ccc 2px,
                #eee 2px,
                #eee 4px
            );
        }
        
        .tag-indicator.untagged:hover {
            background: var(--light);
        }
        
        /* Men√∫ desplegable de etiquetas */
        .tag-menu {
            position: absolute;
            top: 45px;
            right: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            padding: 15px;
            z-index: 100;
            min-width: 280px;
            display: none;
            animation: slideDown 0.2s ease;
            border: 2px solid var(--border);
            max-height: 400px;
            overflow-y: auto;
        }
        
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .tag-menu.show {
            display: block;
        }
        
        .tag-menu h4 {
            margin-bottom: 15px;
            color: var(--dark);
            text-align: center;
            font-size: 16px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }
        
        .tag-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .tag-option {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            border: none;
            background: white;
            text-align: left;
            font-size: 14px;
        }
        
        .tag-option:hover {
            background: var(--light);
            transform: translateX(5px);
        }
        
        .tag-option.active {
            background: var(--light);
            font-weight: 600;
        }
        
        .tag-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            flex-shrink: 0;
            border: 2px solid rgba(255,255,255,0.8);
        }
        
        .tag-section-title {
            font-size: 12px;
            font-weight: 600;
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-top: 15px;
            margin-bottom: 8px;
            padding-left: 5px;
        }
        
        /* Contenido de tarjeta */
        .book-header {
            border-bottom: 2px solid var(--light);
            padding-bottom: 20px;
            margin-bottom: 20px;
            padding-right: 60px;
        }
        
        .book-title {
            font-size: 1.5em;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 8px;
            line-height: 1.4;
        }
        
        .book-author {
            color: var(--primary);
            font-style: italic;
            font-weight: 500;
            font-size: 1.1em;
        }
        
        .fecha-busqueda {
            color: var(--gray);
            font-size: 0.85em;
            display: block;
            margin-top: 10px;
        }
        
        .book-meta {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .badge {
            padding: 8px 16px;
            border-radius: 50px;
            font-size: 0.85em;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .badge-audio {
            background: rgba(39, 174, 96, 0.1);
            color: var(--success);
        }
        
        .badge-educativo {
            background: rgba(243, 156, 18, 0.1);
            color: var(--warning);
        }
        
        .badge-torrent {
            background: rgba(52, 152, 219, 0.1);
            color: var(--primary);
        }
        
        .badge-directo {
            background: rgba(155, 89, 182, 0.1);
            color: var(--purple);
        }
        
        .badge-no-encontrado {
            background: rgba(231, 76, 60, 0.1);
            color: var(--danger);
        }
        
        /* Checkboxes */
        .checkbox-container {
            position: absolute;
            top: 80px;
            right: 15px;
            width: 40%;
            display: grid;
            gap: 2px;
            background: white;
            padding: 1px;
            border-radius: 50px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 50px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .checkbox-group:hover {
            background: var(--light);
        }
        
        .checkbox-group.descargado {
            color: var(--success);
        }
        
        .checkbox-group.no-encontrado {
            color: var(--danger);
        }
        
        .descargado-checkbox,
        .no-encontrado-checkbox {
            width: 22px;
            height: 22px;
            cursor: pointer;
            border-radius: 6px;
            border: 2px solid var(--border);
            appearance: none;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .descargado-checkbox:checked {
            background: var(--success);
            border-color: var(--success);
        }
        
        .no-encontrado-checkbox:checked {
            background: var(--danger);
            border-color: var(--danger);
        }
        
        .descargado-checkbox:checked::after,
        .no-encontrado-checkbox:checked::after {
            content: '‚úì';
            position: absolute;
            color: white;
            font-weight: bold;
            font-size: 14px;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .descargado-checkbox:disabled,
        .no-encontrado-checkbox:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: var(--light);
        }
        
        /* Enlaces */
        .links-section {
            margin-top: 20px;
        }
        
        .platform-links {
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 350px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .platform-links::-webkit-scrollbar {
            width: 8px;
        }
        
        .platform-links::-webkit-scrollbar-track {
            background: var(--light);
            border-radius: 4px;
        }
        
        .platform-links::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .link-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            background: var(--light);
            border-radius: 12px;
            text-decoration: none;
            color: var(--dark);
            transition: all 0.3s ease;
            border-left: 5px solid var(--primary);
            gap: 15px;
        }
        
        .link-item.torrent {
            border-left-color: var(--danger);
        }
        
        .link-item.directo {
            border-left-color: var(--success);
        }
        
        .link-item.audio {
            border-left-color: var(--purple);
        }
        
        .link-item:hover {
            background: var(--primary);
            color: white;
            transform: translateX(5px);
        }
        
        .link-item:hover .link-type {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .link-icon {
            font-size: 1.4em;
            width: 30px;
            text-align: center;
            flex-shrink: 0;
        }
        
        .link-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .link-text {
            font-weight: 600;
            font-size: 1em;
        }
        
        .link-url {
            font-size: 0.85em;
            color: inherit;
            opacity: 0.8;
            word-break: break-all;
        }
        
        .link-type {
            font-size: 0.75em;
            font-weight: 700;
            padding: 4px 12px;
            border-radius: 50px;
            background: rgba(0, 0, 0, 0.1);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            flex-shrink: 0;
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 50px;
            padding: 30px;
            color: white;
            opacity: 0.9;
        }
        
        .footer p {
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        /* Utilidades */
        .hidden {
            display: none !important;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                padding: 25px 20px;
            }
            
            .header h1 {
                font-size: 2.2em;
            }
            
            .search-form {
                grid-template-columns: 1fr;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
                padding: 20px;
            }
            
            .filter-section {
                flex-direction: column;
            }
            
            .filter-buttons {
                justify-content: center;
            }
            
            .counter-section {
                justify-content: center;
            }
            
            .method-btn {
                min-width: 100%;
            }
            
            .book-card {
                padding: 25px 20px;
            }
            
            .book-header {
                padding-right: 60px;
            }
            
            .tag-menu {
                min-width: 250px;
                right: 10px;
            }
            
            .checkbox-container {
                top: 80px;
                right: 15px;
                width: 45%;
            }
            
            .custom-tags-list {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 480px) {
            .books-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .header h1 {
                font-size: 1.8em;
            }
            
            .header p {
                font-size: 1em;
            }
            
            .stat-card {
                padding: 20px 15px;
            }
            
            .stat-number {
                font-size: 2em;
            }
            
            .book-header {
                padding-right: 50px;
            }
            
            .checkbox-container {
                top: 70px;
                width: 50%;
            }
            
            .tag-filter-btn {
                min-width: 100px;
                font-size: 12px;
                padding: 8px 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üéß Buscador de Audiolibros con Etiquetas</h1>
            <p>Organiza tus audiolibros con etiquetas de color ‚Ä¢ Guardado autom√°tico ‚Ä¢ Sistema de prioridades</p>
        </div>

        <!-- Selector de M√©todo de B√∫squeda -->
        <div class="method-selector">
            <button class="method-btn active" onclick="mostrarBusquedaManual()">
                <span>üîç</span>
                <span>B√∫squeda Manual</span>
            </button>
        </div>

        <!-- Panel de B√∫squeda Manual -->
        <div class="search-panel" id="busquedaManualPanel">
            <h2><span>üîç</span> Buscar Libros Manualmente</h2>
            <div class="search-form">
                <div class="input-group">
                    <label for="tituloInput">T√≠tulo del libro</label>
                    <input type="text" id="tituloInput" placeholder="Ej: Cien a√±os de soledad" class="search-input">
                </div>
                <div class="input-group">
                    <label for="autorInput">Autor (opcional)</label>
                    <input type="text" id="autorInput" placeholder="Ej: Gabriel Garc√≠a M√°rquez" class="search-input">
                </div>
                <button onclick="buscarLibroManual()" class="search-btn">
                    <span>üîé</span>
                    <span>Buscar en Todas las Plataformas</span>
                </button>
            </div>
            
            <div class="quick-buttons">
                <button onclick="busquedaRapida('audiolibros')" class="quick-btn">
                    <span>üéß</span>
                    <span>Solo Audiolibros</span>
                </button>
                <button onclick="busquedaRapida('torrents')" class="quick-btn">
                    <span>üß≤</span>
                    <span>Solo Torrents</span>
                </button>
                <button onclick="busquedaRapida('descargas')" class="quick-btn">
                    <span>üì•</span>
                    <span>Solo Descargas</span>
                </button>
            </div>
        </div>

        <!-- Controles -->
        <div class="controls">
            <div class="filter-section">
                <div class="filter-group">
                    <div class="filter-group-label">Filtros de Estado</div>
                    <div class="filter-buttons">
                        <button class="filter-btn active" onclick="filterBooks('all')">Todos</button>
                        <button class="filter-btn" onclick="filterBooks('audio')">Audiolibros</button>
                        <button class="filter-btn" onclick="filterBooks('torrent')">Torrents</button>
                        <button class="filter-btn" onclick="filterBooks('descarga')">Descargas</button>
                        <button class="filter-btn" onclick="filterBooks('descargados')">Descargados</button>
                        <button class="filter-btn no-encontrados" onclick="filterBooks('no-encontrados')">No Encontrados</button>
                        <!-- Bot√≥n para borrar filtros -->
                        <button class="clear-filters-btn" onclick="borrarFiltros()" title="Borrar todos los filtros">
                            <span>üóëÔ∏è</span>
                            <span>Borrar Filtros</span>
                        </button>
                    </div>
                </div>
                
                <div class="filter-group">
                    <div class="filter-group-label">Filtros por Etiquetas</div>
                    <div class="filter-buttons" id="tagFiltersContainer">
                        <!-- Los botones de filtro por etiquetas se generar√°n aqu√≠ -->
                        <button class="filter-btn" onclick="filterByTag('sin-etiqueta')">
                            <span>üè∑Ô∏è</span>
                            <span>Sin Etiqueta</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <div class="counter-section">
                <span class="counter-badge counter-descargados" id="contador-descargados">0 descargados</span>
                <span class="counter-badge counter-noencontrados" id="contador-no-encontrados">0 no encontrados</span>
                <span class="counter-badge counter-etiquetas" id="contador-etiquetas">0 etiquetados</span>
                <button onclick="exportarLista()" class="action-btn export-btn">
                    <span>üíæ</span>
                    <span>Exportar Lista</span>
                </button>
                <button onclick="exportarDatosCompletos()" class="action-btn backup-btn">
                    <span>üì§</span>
                    <span>Exportar Backup</span>
                </button>
                <button onclick="importarDatos()" class="action-btn import-btn">
                    <span>üì•</span>
                    <span>Importar Backup</span>
                </button>
                <button onclick="limpiarBusquedas()" class="action-btn clear-btn">
                    <span>üóëÔ∏è</span>
                    <span>Limpiar Todo</span>
                </button>
                <button class="action-btn tag-manager-btn" onclick="mostrarGestorEtiquetas()">
                    <span>üè∑Ô∏è</span>
                    <span>Gestionar Etiquetas</span>
                </button>
                <!-- NUEVO BOT√ìN PARA REGENERAR ENLACES -->
                <button onclick="regenerarTodosLosEnlaces()" class="action-btn" style="background: #9b59b6;">
                    <span>üîÑ</span>
                    <span>Regenerar Enlaces</span>
                </button>
            </div>
        </div>

        <!-- Estad√≠sticas -->
        <div class="stats" id="statsContainer">
            <div class="stat-card">
                <div class="stat-number" id="totalLibros">0</div>
                <div class="stat-label">Total de Libros</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalEnlaces">0</div>
                <div class="stat-label">Enlaces Generados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="descargadosCount">0</div>
                <div class="stat-label">Descargados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="noEncontradosCount">0</div>
                <div class="stat-label">No Encontrados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="etiquetadosCount">0</div>
                <div class="stat-label">Con Etiqueta</div>
            </div>
        </div>

        <!-- Grid de Resultados -->
        <div class="books-grid" id="booksGrid">
            <div class="welcome-message">
                <h3><span>üëã</span> ¬°Bienvenido al Buscador de Audiolibros con Etiquetas!</h3>
                <p>Usa el formulario de arriba para buscar libros individualmente o sube un archivo CSV con tu lista completa.</p>
                <p><strong>Nuevas funcionalidades:</strong></p>
                <div style="margin-top: 20px; padding: 20px; background: rgba(52, 152, 219, 0.1); border-radius: 12px;">
                    <p style="color: var(--dark); margin-bottom: 10px;"><strong>üé® Sistema de etiquetas personalizadas:</strong></p>
                    <ul style="text-align: left; max-width: 600px; margin: 0 auto; color: var(--gray);">
                        <li>üè∑Ô∏è <strong>Crea etiquetas personalizadas</strong> con cualquier color y nombre</li>
                        <li>üîç <strong>Filtra por etiquetas</strong> usando los botones de filtro en la secci√≥n de controles</li>
                        <li>üóëÔ∏è <strong>Borra filtros</strong> con el bot√≥n "Borrar Filtros"</li>
                        <li>üì§ <strong>Exporta e importa</strong> etiquetas personalizadas con los backups</li>
                        <li>üîß <strong>Gestiona etiquetas</strong> desde el bot√≥n "Gestionar Etiquetas"</li>
                        <li>‚¨áÔ∏è <strong>Los libros "No Encontrados"</strong> aparecen al final de la lista</li>
                        <li>üîÑ <strong>Nuevo:</strong> Regenera enlaces de libros existentes</li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="footer">
            <p>‚ú® Filtra por etiquetas ‚Ä¢ Crea etiquetas personalizadas ‚Ä¢ Exporta e importa datos</p>
            <p>üé® Sistema completo de gesti√≥n de etiquetas ‚Ä¢ üíæ Guardado autom√°tico ‚Ä¢ üîÑ Regeneraci√≥n de enlaces</p>
        </div>
    </div>

    <!-- Modal para Gesti√≥n de Etiquetas -->
    <div class="tag-manager-modal" id="tagManagerModal">
        <div class="tag-manager-content">
            <div class="tag-manager-header">
                <h3><span>üè∑Ô∏è</span> Gestor de Etiquetas Personalizadas</h3>
                <button class="close-modal" onclick="ocultarGestorEtiquetas()">√ó</button>
            </div>
            
            <div class="custom-tags-list" id="customTagsList">
                <!-- Las etiquetas personalizadas se cargar√°n aqu√≠ -->
            </div>
            
            <div class="create-tag-form">
                <h4><span>‚ûï</span> Crear Nueva Etiqueta Personalizada</h4>
                <div class="form-row">
                    <input type="text" id="newTagName" placeholder="Nombre de la etiqueta (ej: Favoritos, Para leer, etc.)" maxlength="30">
                    <div class="color-preview" id="colorPreview" onclick="document.getElementById('colorPicker').click()">
                        <input type="color" id="colorPicker" class="color-input" value="#3498db">
                    </div>
                </div>
                <button onclick="crearNuevaEtiqueta()" class="create-tag-btn">
                    <span>‚ûï</span>
                    <span>Crear Etiqueta Personalizada</span>
                </button>
            </div>
        </div>
    </div>

<script>
    // Sistema completo de b√∫squeda de audiolibros con etiquetas personalizadas
    class BuscadorAudiolibros {
        constructor() {
            // Cargar datos
            this.libros = JSON.parse(localStorage.getItem('librosGuardados')) || [];
            
            // Cargar marcadores
            let descargados = JSON.parse(localStorage.getItem('librosDescargados'));
            let noEncontrados = JSON.parse(localStorage.getItem('librosNoEncontrados'));
            
            this.librosDescargados = (descargados && typeof descargados === 'object') ? descargados : {};
            this.librosNoEncontrados = (noEncontrados && typeof noEncontrados === 'object') ? noEncontrados : {};
            
            // Cargar etiquetas personalizadas y asignaciones
            this.etiquetasPersonalizadas = JSON.parse(localStorage.getItem('etiquetasPersonalizadas')) || [];
            this.librosEtiquetas = JSON.parse(localStorage.getItem('librosEtiquetas')) || {};
            
            // Etiquetas predeterminadas
            this.etiquetasPredeterminadas = [
                { id: 'red', nombre: 'Importante', color: '#e74c3c', tipo: 'predeterminada' },
                { id: 'purple', nombre: 'Normal', color: '#9b59b6', tipo: 'predeterminada' },
                { id: 'green', nombre: 'No Prioritario', color: '#27ae60', tipo: 'predeterminada' },
                { id: 'blue', nombre: 'Pendiente', color: '#3498db', tipo: 'predeterminada' },
                { id: 'orange', nombre: 'Urgente', color: '#f39c12', tipo: 'predeterminada' }
            ];
            
            // Variable para filtro activo
            this.filtroActivo = 'all';
            this.filtroEtiquetaActivo = null;
            
            this.init();
        }

        init() {
            console.log('Datos cargados:', {
                libros: this.libros.length,
                descargados: Object.keys(this.librosDescargados).length,
                noEncontrados: Object.keys(this.librosNoEncontrados).length,
                etiquetasPersonalizadas: this.etiquetasPersonalizadas.length,
                librosEtiquetados: Object.keys(this.librosEtiquetas).length
            });
            
            this.actualizarContadores();
            this.cargarLibrosGuardados();
            this.actualizarEstadisticas();
            this.configurarCierreMenus();
            this.configurarGestorEtiquetas();
            this.actualizarFiltrosEtiquetas();
            
            // Mostrar libros existentes
            if (this.libros.length > 0) {
                this.mostrarLibros();
            }
        }

        configurarCierreMenus() {
            document.addEventListener('click', (event) => {
                if (!event.target.closest('.tag-indicator') && !event.target.closest('.tag-menu')) {
                    this.cerrarTodosLosMenus();
                }
            });
        }
        
        cerrarTodosLosMenus() {
            document.querySelectorAll('.tag-menu.show').forEach(menu => {
                menu.classList.remove('show');
            });
        }

        configurarGestorEtiquetas() {
            const colorPicker = document.getElementById('colorPicker');
            const colorPreview = document.getElementById('colorPreview');
            
            colorPicker.addEventListener('input', (e) => {
                colorPreview.style.backgroundColor = e.target.value;
            });
            
            colorPreview.style.backgroundColor = colorPicker.value;
        }

        guardarDatos() {
            try {
                localStorage.setItem('librosGuardados', JSON.stringify(this.libros));
                localStorage.setItem('librosDescargados', JSON.stringify(this.librosDescargados));
                localStorage.setItem('librosNoEncontrados', JSON.stringify(this.librosNoEncontrados));
                localStorage.setItem('etiquetasPersonalizadas', JSON.stringify(this.etiquetasPersonalizadas));
                localStorage.setItem('librosEtiquetas', JSON.stringify(this.librosEtiquetas));
                
            } catch (e) {
                console.warn('No se pudieron guardar los datos:', e);
                if (e.name === 'QuotaExceededError') {
                    this.limpiarCacheAntiguo();
                }
            }
        }

        // M√âTODO PARA BORRAR FILTROS
        borrarFiltros() {
            this.filtroActivo = 'all';
            this.filtroEtiquetaActivo = null;
            
            // Actualizar botones de filtro de estado
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Activar bot√≥n "Todos"
            const botonTodos = document.querySelector('.filter-btn[onclick*="all"]');
            if (botonTodos) {
                botonTodos.classList.add('active');
            }
            
            // Actualizar interfaz de filtros de etiquetas
            this.actualizarFiltrosEtiquetas();
            
            // Mostrar todos los libros
            this.mostrarLibros();
            
            // Mostrar notificaci√≥n
            this.mostrarNotificacion('Filtros borrados. Mostrando todos los libros.', 'info');
        }

        // M√âTODOS PARA ETIQUETAS PERSONALIZADAS
        
        crearEtiquetaPersonalizada(nombre, color) {
            if (!nombre || !nombre.trim()) {
                this.mostrarNotificacion('Por favor ingresa un nombre para la etiqueta', 'warning');
                return null;
            }
            
            const nombreExistente = this.etiquetasPersonalizadas.find(et => 
                et.nombre.toLowerCase() === nombre.toLowerCase().trim()
            );
            
            if (nombreExistente) {
                this.mostrarNotificacion('Ya existe una etiqueta con ese nombre', 'warning');
                return null;
            }
            
            const nuevaEtiqueta = {
                id: `custom_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                nombre: nombre.trim(),
                color: color,
                tipo: 'personalizada',
                fechaCreacion: new Date().toISOString()
            };
            
            this.etiquetasPersonalizadas.push(nuevaEtiqueta);
            this.guardarDatos();
            this.mostrarNotificacion(`Etiqueta "${nombre}" creada`, 'success');
            
            // Actualizar filtros despu√©s de crear etiqueta
            this.actualizarFiltrosEtiquetas();
            
            return nuevaEtiqueta;
        }

        eliminarEtiquetaPersonalizada(etiquetaId) {
            const index = this.etiquetasPersonalizadas.findIndex(et => et.id === etiquetaId);
            if (index === -1) return false;
            
            const etiqueta = this.etiquetasPersonalizadas[index];
            
            const librosConEstaEtiqueta = Object.keys(this.librosEtiquetas).filter(libroId => 
                this.librosEtiquetas[libroId].id === etiquetaId
            );
            
            if (librosConEstaEtiqueta.length > 0) {
                if (!confirm(`La etiqueta "${etiqueta.nombre}" est√° siendo usada en ${librosConEstaEtiqueta.length} libro(s). ¬øDeseas eliminarla de todos los libros y borrar la etiqueta?`)) {
                    return false;
                }
                
                librosConEstaEtiqueta.forEach(libroId => {
                    delete this.librosEtiquetas[libroId];
                });
            }
            
            this.etiquetasPersonalizadas.splice(index, 1);
            this.guardarDatos();
            this.mostrarLibros();
            this.mostrarNotificacion(`Etiqueta "${etiqueta.nombre}" eliminada`, 'info');
            
            // Actualizar filtros despu√©s de eliminar etiqueta
            this.actualizarFiltrosEtiquetas();
            
            // Si el filtro activo es la etiqueta eliminada, borrar filtro
            if (this.filtroEtiquetaActivo === etiquetaId) {
                this.borrarFiltros();
            }
            
            return true;
        }

        mostrarGestorEtiquetas() {
            const modal = document.getElementById('tagManagerModal');
            modal.classList.add('show');
            this.actualizarListaEtiquetasPersonalizadas();
        }

        ocultarGestorEtiquetas() {
            const modal = document.getElementById('tagManagerModal');
            modal.classList.remove('show');
        }

        actualizarListaEtiquetasPersonalizadas() {
            const lista = document.getElementById('customTagsList');
            
            if (this.etiquetasPersonalizadas.length === 0) {
                lista.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--gray);">
                        <p style="font-size: 1.2em; margin-bottom: 10px;">No hay etiquetas personalizadas</p>
                        <p>Crea tu primera etiqueta personalizada usando el formulario de abajo.</p>
                    </div>
                `;
                return;
            }
            
            lista.innerHTML = this.etiquetasPersonalizadas.map(etiqueta => `
                <div class="custom-tag-item" style="border-left-color: ${etiqueta.color}">
                    <div class="custom-tag-info">
                        <div class="custom-tag-color" style="background: ${etiqueta.color}"></div>
                        <div>
                            <div class="custom-tag-name">${this.escapeHtml(etiqueta.nombre)}</div>
                            <div style="font-size: 12px; color: var(--gray);">${etiqueta.color}</div>
                        </div>
                    </div>
                    <div class="custom-tag-actions">
                        <button class="tag-action-btn tag-edit-btn" onclick="buscador.editarEtiqueta('${etiqueta.id}')">
                            Editar
                        </button>
                        <button class="tag-action-btn tag-delete-btn" onclick="buscador.eliminarEtiquetaPersonalizada('${etiqueta.id}')">
                            Eliminar
                        </button>
                    </div>
                </div>
            `).join('');
        }

        editarEtiqueta(etiquetaId) {
            const etiqueta = this.etiquetasPersonalizadas.find(et => et.id === etiquetaId);
            if (!etiqueta) return;
            
            const nuevoNombre = prompt(`Editar nombre de la etiqueta:`, etiqueta.nombre);
            if (nuevoNombre && nuevoNombre.trim() && nuevoNombre.trim() !== etiqueta.nombre) {
                const nombreExistente = this.etiquetasPersonalizadas.find(et => 
                    et.id !== etiquetaId && et.nombre.toLowerCase() === nuevoNombre.toLowerCase().trim()
                );
                
                if (nombreExistente) {
                    this.mostrarNotificacion('Ya existe otra etiqueta con ese nombre', 'warning');
                    return;
                }
                
                etiqueta.nombre = nuevoNombre.trim();
                this.guardarDatos();
                this.actualizarListaEtiquetasPersonalizadas();
                this.actualizarFiltrosEtiquetas();
                this.mostrarLibros();
                this.mostrarNotificacion('Etiqueta actualizada', 'success');
            }
        }

        // M√©todo para asignar etiqueta a un libro
        asignarEtiqueta(libroId, etiquetaId, nombre, color, tipo) {
            if (!libroId) return;
            
            // Si se solicita eliminar la etiqueta
            if (etiquetaId === 'remove') {
                delete this.librosEtiquetas[libroId];
                this.guardarDatos();
                this.mostrarNotificacion('Etiqueta eliminada', 'info');
                
                // Actualizar la tarjeta
                this.actualizarTarjetaEtiqueta(libroId, null);
                // Reordenar y mostrar libros
                this.mostrarLibros();
                
                return;
            }
            
            // Crear objeto etiqueta
            const etiqueta = {
                id: etiquetaId,
                nombre: nombre,
                color: color,
                tipo: tipo || 'predeterminada',
                fechaAsignacion: new Date().toISOString()
            };
            
            // Guardar la etiqueta
            this.librosEtiquetas[libroId] = etiqueta;
            
            this.guardarDatos();
            
            // Actualizar la tarjeta
            this.actualizarTarjetaEtiqueta(libroId, etiqueta);
            
            this.mostrarNotificacion(`Etiqueta "${nombre}" asignada`, 'success');
            this.actualizarEstadisticas();
            this.actualizarContadores();
            
            // Reordenar y mostrar libros
            this.mostrarLibros();
        }

        // M√©todo para actualizar solo la etiqueta de la tarjeta
        actualizarTarjetaEtiqueta(libroId, etiqueta) {
            const card = document.getElementById(`card_${libroId}`);
            if (!card) return;
            
            const indicator = card.querySelector('.tag-indicator');
            const menu = document.getElementById(`tagMenu_${libroId}`);
            
            if (etiqueta) {
                // Aplicar etiqueta
                indicator.className = 'tag-indicator';
                indicator.style.backgroundColor = etiqueta.color;
                indicator.title = `${etiqueta.nombre} - Click para cambiar`;
                
                // Actualizar opci√≥n activa en el men√∫
                if (menu) {
                    menu.querySelectorAll('.tag-option').forEach(option => {
                        option.classList.remove('active');
                    });
                }
            } else {
                // Quitar etiqueta
                indicator.className = 'tag-indicator untagged';
                indicator.style.backgroundColor = '';
                indicator.title = 'Sin etiqueta - Click para asignar';
                
                // Remover opci√≥n activa en el men√∫
                if (menu) {
                    menu.querySelectorAll('.tag-option').forEach(option => {
                        option.classList.remove('active');
                    });
                }
            }
        }

        // Mostrar/ocultar men√∫ de etiquetas
        toggleMenuEtiquetas(libroId, event) {
            if (event) event.stopPropagation();
            
            this.cerrarTodosLosMenus();
            
            const menu = document.getElementById(`tagMenu_${libroId}`);
            if (menu) {
                menu.classList.toggle('show');
            }
        }

        // NUEVO: Actualizar filtros de etiquetas en la interfaz
        actualizarFiltrosEtiquetas() {
            const container = document.getElementById('tagFiltersContainer');
            const todasLasEtiquetas = [
                ...this.etiquetasPredeterminadas,
                ...this.etiquetasPersonalizadas
            ];
            
            let html = `
                <button class="filter-btn ${this.filtroEtiquetaActivo === 'todas-etiquetas' ? 'active' : ''}" onclick="filterByTag('todas-etiquetas')">
                    <span>üè∑Ô∏è</span>
                    <span>Todas las Etiquetas</span>
                </button>
                <button class="filter-btn ${this.filtroEtiquetaActivo === 'sin-etiqueta' ? 'active' : ''}" onclick="filterByTag('sin-etiqueta')">
                    <span>üîò</span>
                    <span>Sin Etiqueta</span>
                </button>
            `;
            
            todasLasEtiquetas.forEach(etiqueta => {
                const activo = this.filtroEtiquetaActivo === etiqueta.id ? 'active' : '';
                html += `
                    <button class="tag-filter-btn ${activo}" 
                            onclick="filterByTag('${etiqueta.id}')"
                            style="background: ${etiqueta.color}20; color: ${etiqueta.color}; border: 2px solid ${etiqueta.color}30;">
                        <span class="tag-filter-color" style="background: ${etiqueta.color}"></span>
                        <span>${etiqueta.nombre}</span>
                    </button>
                `;
            });
            
            container.innerHTML = html;
        }

        // NUEVO: Filtrar libros por etiqueta
        filtrarLibrosPorEtiqueta(etiquetaId = null) {
            this.filtroEtiquetaActivo = etiquetaId;
            
            // Actualizar estado de botones
            this.actualizarFiltrosEtiquetas();
            
            // Aplicar filtros actuales
            this.aplicarFiltrosActuales();
        }

        // NUEVO: M√©todo para aplicar filtro de estado
        aplicarFiltrosActuales() {
            const cards = document.querySelectorAll('.book-card');
            let hayResultados = false;
            
            cards.forEach(card => {
                const libroId = card.id.replace('card_', '');
                const etiquetaAsignada = this.librosEtiquetas[libroId];
                
                let mostrar = true;
                
                // Aplicar filtro de etiqueta si existe
                if (this.filtroEtiquetaActivo) {
                    if (this.filtroEtiquetaActivo === 'todas-etiquetas') {
                        // Mostrar solo libros que tienen etiqueta
                        mostrar = !!etiquetaAsignada;
                    } else if (this.filtroEtiquetaActivo === 'sin-etiqueta') {
                        // Mostrar solo libros sin etiqueta
                        mostrar = !etiquetaAsignada;
                    } else {
                        // Mostrar solo libros con una etiqueta espec√≠fica
                        mostrar = etiquetaAsignada && etiquetaAsignada.id === this.filtroEtiquetaActivo;
                    }
                }
                
                // Aplicar tambi√©n el filtro de estado si hay uno activo y el libro todav√≠a pasa el filtro
                if (mostrar && this.filtroActivo !== 'all') {
                    mostrar = this.aplicarFiltroEstado(card, this.filtroActivo);
                }
                
                card.style.display = mostrar ? 'block' : 'none';
                if (mostrar) {
                    card.style.animation = 'fadeIn 0.3s ease';
                    hayResultados = true;
                }
            });
            
            // Si no hay resultados y hay filtros activos, mostrar mensaje
            if (!hayResultados && (this.filtroActivo !== 'all' || this.filtroEtiquetaActivo)) {
                this.mostrarMensajeSinResultados();
            } else if (!hayResultados && this.libros.length === 0) {
                // No hay libros en absoluto
                this.mostrarMensajeBienvenida();
            }
        }

        // NUEVO: M√©todo para aplicar filtro de estado
        aplicarFiltroEstado(card, filtro) {
            switch(filtro) {
                case 'all':
                    return true;
                case 'audio':
                    return card.querySelector('.link-item.audio') !== null;
                case 'torrent':
                    return card.querySelector('.link-item.torrent') !== null;
                case 'descarga':
                    return card.querySelector('.link-item.directo') !== null;
                case 'descargados':
                    return card.classList.contains('descargado');
                case 'no-encontrados':
                    return card.classList.contains('no-encontrado');
                default:
                    return true;
            }
        }

        // NUEVO: Mostrar mensaje cuando no hay resultados
        mostrarMensajeSinResultados() {
            const grid = document.getElementById('booksGrid');
            let mensaje = '';
            
            // Construir mensaje seg√∫n los filtros activos
            if (this.filtroEtiquetaActivo && this.filtroActivo !== 'all') {
                const etiqueta = this.obtenerNombreEtiqueta(this.filtroEtiquetaActivo);
                const filtroEstado = this.obtenerNombreFiltro(this.filtroActivo);
                mensaje = `No hay libros con la etiqueta "${etiqueta}" y estado "${filtroEstado}"`;
            } else if (this.filtroEtiquetaActivo) {
                const etiqueta = this.obtenerNombreEtiqueta(this.filtroEtiquetaActivo);
                mensaje = `No hay libros con la etiqueta "${etiqueta}"`;
            } else if (this.filtroActivo !== 'all') {
                const filtro = this.obtenerNombreFiltro(this.filtroActivo);
                mensaje = `No hay libros con el filtro "${filtro}"`;
            }
            
            const mensajeDiv = document.createElement('div');
            mensajeDiv.className = 'welcome-message';
            mensajeDiv.innerHTML = `
                <h3><span>üîç</span> No se encontraron resultados</h3>
                <p>${mensaje}.</p>
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button onclick="borrarFiltros()" style="
                        padding: 12px 24px;
                        background: var(--primary);
                        color: white;
                        border: none;
                        border-radius: 50px;
                        cursor: pointer;
                        font-weight: 500;
                    ">Borrar Filtros y Ver Todos</button>
                </div>
            `;
            
            grid.innerHTML = '';
            grid.appendChild(mensajeDiv);
        }

        // NUEVO: Mostrar mensaje de bienvenida cuando no hay libros
        mostrarMensajeBienvenida() {
            const grid = document.getElementById('booksGrid');
            grid.innerHTML = `
                <div class="welcome-message">
                    <h3><span>üëã</span> ¬°Comienza a buscar audiolibros!</h3>
                    <p>Usa el formulario de arriba para buscar libros individualmente.</p>
                    <p><strong>Nueva funcionalidad:</strong> Crea etiquetas personalizadas con colores √∫nicos y filtra por ellas.</p>
                </div>
            `;
        }

        // NUEVO: Obtener nombre de etiqueta para mensaje
        obtenerNombreEtiqueta(etiquetaId) {
            if (etiquetaId === 'todas-etiquetas') return 'Todas las Etiquetas';
            if (etiquetaId === 'sin-etiqueta') return 'Sin Etiqueta';
            
            const etiqueta = [...this.etiquetasPredeterminadas, ...this.etiquetasPersonalizadas]
                .find(e => e.id === etiquetaId);
            return etiqueta ? etiqueta.nombre : etiquetaId;
        }

        // NUEVO: Obtener nombre de filtro para mensaje
        obtenerNombreFiltro(filtro) {
            const nombres = {
                'all': 'Todos',
                'audio': 'Audiolibros',
                'torrent': 'Torrents',
                'descarga': 'Descargas',
                'descargados': 'Descargados',
                'no-encontrados': 'No Encontrados'
            };
            return nombres[filtro] || filtro;
        }

        cargarLibrosGuardados() {
            if (this.libros.length > 0) {
                this.mostrarLibros();
            }
        }

        // MODIFICADO: NUEVO SISTEMA DE ORDENAMIENTO JER√ÅRQUICO
        mostrarLibros() {
            const grid = document.getElementById('booksGrid');
            
            if (this.libros.length === 0) {
                this.mostrarMensajeBienvenida();
                return;
            }

            // SISTEMA DE ORDENAMIENTO JER√ÅRQUICO:
            // 1. TOP: Libros con etiqueta (pero NO descargados y NO "no encontrados")
            // 2. MIDDLE: Libros sin ning√∫n estado
            // 3. LOW MIDDLE: Libros marcados como "No Encontrados"
            // 4. BOTTOM: Libros marcados como "Descargados"
            
            const librosOrdenados = [...this.libros].sort((a, b) => {
                const aDescargado = this.librosDescargados[a.id] || false;
                const bDescargado = this.librosDescargados[b.id] || false;
                const aNoEncontrado = this.librosNoEncontrados[a.id] || false;
                const bNoEncontrado = this.librosNoEncontrados[b.id] || false;
                const aEtiqueta = this.librosEtiquetas[a.id];
                const bEtiqueta = this.librosEtiquetas[b.id];
                
                // Funci√≥n para calcular peso jer√°rquico
                const calcularPeso = (libroId) => {
                    let peso = 0;
                    const descargado = this.librosDescargados[libroId];
                    const noEncontrado = this.librosNoEncontrados[libroId];
                    const etiqueta = this.librosEtiquetas[libroId];
                    
                    // Nivel 4: Descargados (m√°s bajo)
                    if (descargado) return 4;
                    // Nivel 3: No encontrados
                    if (noEncontrado) return 3;
                    // Nivel 2: Sin estado (sin etiqueta, sin marcar)
                    if (!etiqueta) return 2;
                    // Nivel 1: Con etiqueta (m√°s alto)
                    return 1;
                };
                
                const pesoA = calcularPeso(a.id);
                const pesoB = calcularPeso(b.id);
                
                // Ordenar por peso jer√°rquico
                if (pesoA !== pesoB) {
                    return pesoA - pesoB;
                }
                
                // Si tienen el mismo peso jer√°rquico, ordenar por fecha (m√°s recientes primero)
                return b.timestamp - a.timestamp;
            });

            grid.innerHTML = librosOrdenados.map(libro => this.crearTarjetaLibro(libro)).join('');
            this.aplicarMarcadoresGuardados();
            
            // Aplicar filtros actuales si hay alguno activo
            if (this.filtroActivo !== 'all' || this.filtroEtiquetaActivo) {
                this.aplicarFiltrosActuales();
            }
        }

        crearTarjetaLibro(libro) {
            if (!libro.titulo) {
                console.error('Libro sin t√≠tulo:', libro);
                return '';
            }
            
            const torrentCount = libro.enlaces ? libro.enlaces.filter(e => e.tipo === 'TORRENT').length : 0;
            const directoCount = libro.enlaces ? libro.enlaces.filter(e => e.esDirecto).length : 0;
            const audioCount = libro.enlaces ? libro.enlaces.filter(e => e.tipo === 'AUDIOLIBRO').length : 0;
            const fecha = libro.fechaBusqueda ? new Date(libro.fechaBusqueda).toLocaleDateString('es-ES', {
                day: '2-digit',
                month: 'short',
                year: 'numeric'
            }) : 'Fecha desconocida';
            
            const esDescargado = this.librosDescargados[libro.id];
            const esNoEncontrado = this.librosNoEncontrados[libro.id];
            const etiquetaAsignada = this.librosEtiquetas[libro.id];
            
            // Determinar etiqueta actual
            let tagClass = 'untagged';
            let tagStyle = '';
            let tagTitle = 'Sin etiqueta - Click para asignar';
            
            if (etiquetaAsignada) {
                tagClass = '';
                tagStyle = `style="background: ${etiquetaAsignada.color}"`;
                tagTitle = `${etiquetaAsignada.nombre} - Click para cambiar`;
            }

            return `
                <div class="book-card ${esDescargado ? 'descargado' : ''} ${esNoEncontrado ? 'no-encontrado' : ''}" id="card_${libro.id}">
                    
                    <!-- Indicador de etiqueta -->
                    <div class="tag-indicator ${tagClass}" 
                         ${tagStyle}
                         onclick="buscador.toggleMenuEtiquetas('${libro.id}', event)"
                         title="${tagTitle}">
                    </div>
                    
                    <!-- Checkboxes para descargado/no encontrado -->
                    <div class="checkbox-container">
                        <div class="checkbox-group descargado">
                            <input type="checkbox" id="check_descargado_${libro.id}" class="descargado-checkbox" 
                                   onchange="buscador.actualizarMarcador('descargado', this)" 
                                   ${esDescargado ? 'checked' : ''} 
                                   ${esNoEncontrado ? 'disabled' : ''}>
                            <label for="check_descargado_${libro.id}" title="Marcar como descargado">
                                <span style="font-size: 1.2em;">‚úì</span>
                                <span style="font-size: 0.8em;">Descargado</span>
                            </label>
                        </div>
                        
                        <div class="checkbox-group no-encontrado">
                            <input type="checkbox" id="check_noencontrado_${libro.id}" class="no-encontrado-checkbox" 
                                   onchange="buscador.actualizarMarcador('no-encontrado', this)" 
                                   ${esNoEncontrado ? 'checked' : ''} 
                                   ${esDescargado ? 'disabled' : ''}>
                            <label for="check_noencontrado_${libro.id}" title="Marcar como no encontrado">
                                <span style="font-size: 1.2em;">‚úó</span>
                                <span style="font-size: 0.8em;">No Encontrado</span>
                            </label>
                        </div>
                    </div>
                    
                    <!-- Men√∫ desplegable de etiquetas -->
                    <div class="tag-menu" id="tagMenu_${libro.id}">
                        <h4>Asignar Etiqueta</h4>
                        
                        <div class="tag-section-title">Etiquetas Predeterminadas</div>
                        <div class="tag-options">
                            ${this.etiquetasPredeterminadas.map(etiqueta => `
                                <button class="tag-option ${etiquetaAsignada?.id === etiqueta.id ? 'active' : ''}" 
                                        onclick="buscador.asignarEtiqueta('${libro.id}', '${etiqueta.id}', '${this.escapeHtml(etiqueta.nombre)}', '${etiqueta.color}', 'predeterminada')">
                                    <span class="tag-color" style="background: ${etiqueta.color}"></span>
                                    <span>${etiqueta.nombre}</span>
                                </button>
                            `).join('')}
                        </div>
                        
                        ${this.etiquetasPersonalizadas.length > 0 ? `
                            <div class="tag-section-title">Etiquetas Personalizadas</div>
                            <div class="tag-options">
                                ${this.etiquetasPersonalizadas.map(etiqueta => `
                                    <button class="tag-option ${etiquetaAsignada?.id === etiqueta.id ? 'active' : ''}" 
                                            onclick="buscador.asignarEtiqueta('${libro.id}', '${etiqueta.id}', '${this.escapeHtml(etiqueta.nombre)}', '${etiqueta.color}', 'personalizada')">
                                        <span class="tag-color" style="background: ${etiqueta.color}"></span>
                                        <span>${etiqueta.nombre}</span>
                                    </button>
                                `).join('')}
                            </div>
                        ` : ''}
                        
                        ${etiquetaAsignada ? `
                            <div class="tag-options" style="margin-top: 15px;">
                                <button class="tag-option" 
                                        onclick="buscador.asignarEtiqueta('${libro.id}', 'remove')"
                                        style="color: var(--danger);">
                                    <span>‚úó</span>
                                    <span>Eliminar etiqueta</span>
                                </button>
                            </div>
                        ` : ''}
                    </div>
                    
                    <!-- Contenido de la tarjeta -->
                    <div class="book-header">
                        <div class="book-title">${this.escapeHtml(libro.titulo)}</div>
                        <div class="book-author">${this.escapeHtml(libro.autor || 'Autor desconocido')}</div>
                        <small class="fecha-busqueda">B√∫squeda: ${fecha}</small>
                    </div>
                    
                    <div class="book-meta">
                        <span class="badge ${libro.prioridadAudio === 'ALTA' ? 'badge-audio' : 'badge-educativo'}">
                            ${libro.prioridadAudio === 'ALTA' ? 'üéß' : 'üìö'} ${libro.prioridadAudio || 'MEDIA'}
                        </span>
                        <span class="badge ${libro.esEducativo === 'S√≠' ? 'badge-educativo' : 'badge-descarga'}">
                            üìö ${libro.esEducativo || 'No'}
                        </span>
                        ${torrentCount > 0 ? `<span class="badge badge-torrent">üß≤ ${torrentCount} torrents</span>` : ''}
                        ${directoCount > 0 ? `<span class="badge badge-directo">üì• ${directoCount} directos</span>` : ''}
                        ${audioCount > 0 ? `<span class="badge badge-audio">üéß ${audioCount} audiolibros</span>` : ''}
                        ${esNoEncontrado ? `<span class="badge badge-no-encontrado">‚úó No Encontrado</span>` : ''}
                        ${etiquetaAsignada ? `<span class="badge" style="background: ${etiquetaAsignada.color}20; color: ${etiquetaAsignada.color};">
                            <span style="display: inline-block; width: 10px; height: 10px; background: ${etiquetaAsignada.color}; border-radius: 50%; margin-right: 5px;"></span>
                            ${etiquetaAsignada.nombre}
                        </span>` : ''}
                    </div>
                    
                    <div class="links-section">
                        <div class="platform-links">
                            ${libro.enlaces && libro.enlaces.length > 0 ? libro.enlaces.map(enlace => `
                                <a href="${enlace.url}" target="_blank" rel="noopener noreferrer" 
                                   class="link-item ${enlace.tipo ? enlace.tipo.toLowerCase() : 'busqueda'}"
                                   title="${enlace.plataforma} - ${enlace.url}">
                                    <span class="link-icon">${enlace.icono || 'üîó'}</span>
                                    <div class="link-content">
                                        <span class="link-text">${enlace.plataforma}</span>
                                        <span class="link-url">${this.acortarURL(enlace.url)}</span>
                                    </div>
                                    <span class="link-type">${enlace.tipo || 'BUSQUEDA'}</span>
                                </a>
                            `).join('') : '<div class="no-enlaces-mensaje">No se encontraron enlaces para este libro</div>'}
                        </div>
                    </div>
                </div>
            `;
        }

        // M√âTODOS DE EXPORTACI√ìN E IMPORTACI√ìN
        exportarDatosCompletos() {
            if (this.libros.length === 0) {
                this.mostrarNotificacion('No hay datos para exportar', 'warning');
                return;
            }

            const datos = {
                libros: this.libros,
                librosDescargados: this.librosDescargados,
                librosNoEncontrados: this.librosNoEncontrados,
                etiquetasPersonalizadas: this.etiquetasPersonalizadas,
                librosEtiquetas: this.librosEtiquetas,
                fechaExportacion: new Date().toISOString(),
                version: '4.0',
                totalLibros: this.libros.length,
                totalDescargados: Object.keys(this.librosDescargados).length,
                totalNoEncontrados: Object.keys(this.librosNoEncontrados).length,
                totalEtiquetasPersonalizadas: this.etiquetasPersonalizadas.length,
                totalLibrosEtiquetados: Object.keys(this.librosEtiquetas).length
            };

            const contenido = JSON.stringify(datos, null, 2);
            const blob = new Blob([contenido], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fecha = new Date().toISOString().split('T')[0];
            a.download = `audiolibros_completo_${fecha}.json`;
            
            a.style.display = 'none';
            document.body.appendChild(a);
            a.click();
            
            setTimeout(() => {
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                this.mostrarNotificacion(`Backup exportado con ${this.etiquetasPersonalizadas.length} etiquetas personalizadas`, 'success');
            }, 100);
        }

        importarDatos() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const datos = JSON.parse(event.target.result);
                        
                        if (!datos.libros || !Array.isArray(datos.libros)) {
                            throw new Error('Formato de archivo inv√°lido');
                        }
                        
                        const totalEtiquetas = datos.etiquetasPersonalizadas?.length || 0;
                        const totalLibrosEtiquetados = Object.keys(datos.librosEtiquetas || {}).length;
                        
                        const mensajeConfirmacion = `¬øImportar ${datos.libros.length} libros?\n\n` +
                            `Incluye:\n` +
                            `‚Ä¢ ${Object.keys(datos.librosDescargados || {}).length} marcados como descargados\n` +
                            `‚Ä¢ ${Object.keys(datos.librosNoEncontrados || {}).length} marcados como no encontrados\n` +
                            `‚Ä¢ ${totalEtiquetas} etiquetas personalizadas\n` +
                            `‚Ä¢ ${totalLibrosEtiquetados} libros con etiquetas asignadas\n\n` +
                            `Esto sobrescribir√° los datos actuales.`;
                        
                        if (confirm(mensajeConfirmacion)) {
                            this.libros = datos.libros || [];
                            this.librosDescargados = datos.librosDescargados || {};
                            this.librosNoEncontrados = datos.librosNoEncontrados || {};
                            
                            if (datos.etiquetasPersonalizadas && Array.isArray(datos.etiquetasPersonalizadas)) {
                                this.etiquetasPersonalizadas = datos.etiquetasPersonalizadas;
                            }
                            
                            if (datos.librosEtiquetas && typeof datos.librosEtiquetas === 'object') {
                                this.librosEtiquetas = datos.librosEtiquetas;
                            }
                            
                            // Borrar filtros activos
                            this.borrarFiltros();
                            
                            this.guardarDatos();
                            this.mostrarLibros();
                            this.actualizarEstadisticas();
                            this.actualizarContadores();
                            this.actualizarListaEtiquetasPersonalizadas();
                            this.actualizarFiltrosEtiquetas();
                            
                            const mensajeExito = `Importados ${datos.libros.length} libros:\n` +
                                `‚Ä¢ ${Object.keys(datos.librosDescargados || {}).length} descargados\n` +
                                `‚Ä¢ ${Object.keys(datos.librosNoEncontrados || {}).length} no encontrados\n` +
                                `‚Ä¢ ${totalEtiquetas} etiquetas personalizadas\n` +
                                `‚Ä¢ ${totalLibrosEtiquetados} libros etiquetados`;
                            
                            this.mostrarNotificacion(mensajeExito, 'success');
                        }
                    } catch (error) {
                        this.mostrarNotificacion(`Error: ${error.message}`, 'error');
                    }
                };
                
                reader.onerror = () => {
                    this.mostrarNotificacion('Error al leer el archivo', 'error');
                };
                
                reader.readAsText(file);
            };
            
            input.click();
        }

        // M√©todos auxiliares
        actualizarEstadisticas() {
            const totalLibros = this.libros.length;
            const totalEnlaces = this.libros.reduce((sum, libro) => sum + (libro.enlaces ? libro.enlaces.length : 0), 0);
            const descargadosCount = Object.keys(this.librosDescargados).length;
            const noEncontradosCount = Object.keys(this.librosNoEncontrados).length;
            const etiquetadosCount = Object.keys(this.librosEtiquetas).length;

            document.getElementById('totalLibros').textContent = totalLibros.toLocaleString();
            document.getElementById('totalEnlaces').textContent = totalEnlaces.toLocaleString();
            document.getElementById('descargadosCount').textContent = descargadosCount.toLocaleString();
            document.getElementById('noEncontradosCount').textContent = noEncontradosCount.toLocaleString();
            document.getElementById('etiquetadosCount').textContent = etiquetadosCount.toLocaleString();
        }

        buscarLibro(titulo, autor, tipoBusqueda = 'completa') {
            if (!titulo || !titulo.trim()) {
                this.mostrarNotificacion('Por favor ingresa al menos el t√≠tulo del libro', 'warning');
                document.getElementById('tituloInput').focus();
                return;
            }

            if (!autor || !autor.trim()) {
                autor = 'Autor Desconocido';
            }

            const libroExistente = this.libros.find(libro => 
                libro.titulo && libro.titulo.toLowerCase() === titulo.toLowerCase() && 
                libro.autor && libro.autor.toLowerCase() === autor.toLowerCase()
            );

            const libroId = libroExistente ? libroExistente.id : `libro_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;

            const libro = {
                id: libroId,
                titulo: titulo.trim(),
                autor: autor.trim(),
                esEducativo: this.esEducativo(titulo) ? 'S√≠' : 'No',
                prioridadAudio: this.esEducativo(titulo) ? 'MEDIA' : 'ALTA',
                enlaces: [],
                fechaBusqueda: new Date().toISOString(),
                timestamp: Date.now()
            };

            const todosEnlaces = this.generarEnlaces(titulo, autor);
            let enlacesFiltrados = 0;
            
            Object.entries(todosEnlaces).forEach(([plataforma, url]) => {
                const analisis = this.analizarEnlace(plataforma, url);
                
                let incluir = true;
                if (tipoBusqueda === 'audiolibros') {
                    incluir = ['AUDIOLIBRO', 'TORRENT'].includes(analisis.tipo);
                } else if (tipoBusqueda === 'torrents') {
                    incluir = analisis.tipo === 'TORRENT';
                } else if (tipoBusqueda === 'descargas') {
                    incluir = ['DESCARGA', 'TORRENT'].includes(analisis.tipo);
                }

                if (incluir) {
                    libro.enlaces.push({
                        plataforma: plataforma,
                        url: url,
                        tipo: analisis.tipo,
                        icono: analisis.icono,
                        esDirecto: analisis.esDirecto
                    });
                    enlacesFiltrados++;
                }
            });

            if (libroExistente) {
                const index = this.libros.findIndex(l => l.id === libroExistente.id);
                if (index !== -1) {
                    const marcadoresPreservados = {
                        descargado: this.librosDescargados[libroExistente.id],
                        noEncontrado: this.librosNoEncontrados[libroExistente.id],
                        etiqueta: this.librosEtiquetas[libroExistente.id]
                    };
                    
                    this.libros[index] = libro;
                    
                    if (marcadoresPreservados.descargado) {
                        this.librosDescargados[libroId] = marcadoresPreservados.descargado;
                    }
                    if (marcadoresPreservados.noEncontrado) {
                        this.librosNoEncontrados[libroId] = marcadoresPreservados.noEncontrado;
                    }
                    if (marcadoresPreservados.etiqueta) {
                        this.librosEtiquetas[libroId] = marcadoresPreservados.etiqueta;
                    }
                    
                    delete this.librosDescargados[libroExistente.id];
                    delete this.librosNoEncontrados[libroExistente.id];
                    delete this.librosEtiquetas[libroExistente.id];
                }
            } else {
                this.libros.unshift(libro);
            }

            if (enlacesFiltrados === 0) {
                this.librosNoEncontrados[libroId] = {
                    fecha: new Date().toISOString(),
                    razon: 'No se encontraron enlaces v√°lidos en la b√∫squeda'
                };
                delete this.librosDescargados[libroId];
            } else {
                delete this.librosNoEncontrados[libroId];
            }

            this.guardarDatos();
            this.mostrarLibros();
            this.actualizarEstadisticas();
            this.actualizarContadores();

            document.getElementById('tituloInput').value = '';
            document.getElementById('autorInput').value = '';
            document.getElementById('tituloInput').focus();

            if (enlacesFiltrados > 0) {
                const mensaje = tipoBusqueda === 'completa' 
                    ? `"${titulo}" - ${enlacesFiltrados} enlaces encontrados`
                    : `"${titulo}" - ${enlacesFiltrados} enlaces de ${tipoBusqueda}`;
                this.mostrarNotificacion(mensaje, 'success');
            } else {
                this.mostrarNotificacion(`"${titulo}" - No se encontraron enlaces. Marcado como "No Encontrado".`, 'warning');
            }
        }

        // MODIFICADO: M√©todo para actualizar marcadores con reordenamiento autom√°tico
        actualizarMarcador(tipo, checkbox) {
            const card = checkbox.closest('.book-card');
            const checkboxId = checkbox.id;
            
            let libroId;
            if (tipo === 'descargado') {
                libroId = checkboxId.replace('check_descargado_', '');
            } else if (tipo === 'no-encontrado') {
                libroId = checkboxId.replace('check_noencontrado_', '');
            }
            
            const descargadoCheckbox = document.getElementById(`check_descargado_${libroId}`);
            const noEncontradoCheckbox = document.getElementById(`check_noencontrado_${libroId}`);
            
            if (tipo === 'descargado') {
                if (checkbox.checked) {
                    card.classList.add('descargado');
                    this.librosDescargados[libroId] = {
                        fecha: new Date().toISOString(),
                        marcado: true
                    };
                    
                    if (noEncontradoCheckbox) {
                        noEncontradoCheckbox.checked = false;
                        noEncontradoCheckbox.disabled = true;
                    }
                    
                    card.classList.remove('no-encontrado');
                    delete this.librosNoEncontrados[libroId];
                    
                    this.mostrarNotificacion('Libro marcado como descargado', 'success');
                    
                } else {
                    card.classList.remove('descargado');
                    delete this.librosDescargados[libroId];
                    
                    if (noEncontradoCheckbox) {
                        noEncontradoCheckbox.disabled = false;
                    }
                    
                    this.mostrarNotificacion('Marcador de descargado eliminado', 'info');
                }
            } else if (tipo === 'no-encontrado') {
                if (checkbox.checked) {
                    card.classList.add('no-encontrado');
                    this.librosNoEncontrados[libroId] = {
                        fecha: new Date().toISOString(),
                        razon: 'Marcado manualmente por el usuario'
                    };
                    
                    if (descargadoCheckbox) {
                        descargadoCheckbox.checked = false;
                        descargadoCheckbox.disabled = true;
                    }
                    
                    card.classList.remove('descargado');
                    delete this.librosDescargados[libroId];
                    
                    this.mostrarNotificacion('Libro marcado como no encontrado', 'warning');
                } else {
                    card.classList.remove('no-encontrado');
                    delete this.librosNoEncontrados[libroId];
                    
                    if (descargadoCheckbox) {
                        descargadoCheckbox.disabled = false;
                    }
                    
                    this.mostrarNotificacion('Marcador de no encontrado eliminado', 'info');
                }
            }
            
            this.guardarDatos();
            this.actualizarContadores();
            this.actualizarEstadisticas();
            
            // REORDENAR y mostrar libros autom√°ticamente
            this.mostrarLibros();
            
            // Si hay filtros activos, aplicar nuevamente
            if (this.filtroActivo !== 'all' || this.filtroEtiquetaActivo) {
                this.aplicarFiltrosActuales();
            }
        }

        aplicarMarcadoresGuardados() {
            Object.keys(this.librosDescargados).forEach(libroId => {
                const checkbox = document.getElementById('check_descargado_' + libroId);
                const otroCheckbox = document.getElementById('check_noencontrado_' + libroId);
                if (checkbox) {
                    checkbox.checked = true;
                    if (checkbox.closest('.book-card')) {
                        checkbox.closest('.book-card').classList.add('descargado');
                    }
                    if (otroCheckbox) otroCheckbox.disabled = true;
                }
            });
            
            Object.keys(this.librosNoEncontrados).forEach(libroId => {
                const checkbox = document.getElementById('check_noencontrado_' + libroId);
                const otroCheckbox = document.getElementById('check_descargado_' + libroId);
                if (checkbox) {
                    checkbox.checked = true;
                    if (checkbox.closest('.book-card')) {
                        checkbox.closest('.book-card').classList.add('no-encontrado');
                    }
                    if (otroCheckbox) otroCheckbox.disabled = true;
                }
            });
        }

        actualizarContadores() {
            const countDescargados = Object.keys(this.librosDescargados).length;
            const countNoEncontrados = Object.keys(this.librosNoEncontrados).length;
            const countEtiquetados = Object.keys(this.librosEtiquetas).length;
            
            document.getElementById('contador-descargados').textContent = 
                `${countDescargados} descargado${countDescargados !== 1 ? 's' : ''}`;
            document.getElementById('contador-no-encontrados').textContent = 
                `${countNoEncontrados} no encontrado${countNoEncontrados !== 1 ? 's' : ''}`;
            document.getElementById('contador-etiquetas').textContent = 
                `${countEtiquetados} etiquetado${countEtiquetados !== 1 ? 's' : ''}`;
        }

        // M√©todos auxiliares
        escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        acortarURL(url, maxLength = 50) {
            if (!url) return '';
            if (url.length <= maxLength) return url;
            return url.substring(0, maxLength) + '...';
        }

        mostrarNotificacion(mensaje, tipo = 'info') {
            const notificacion = document.createElement('div');
            notificacion.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 25px;
                border-radius: 12px;
                color: white;
                font-weight: 500;
                z-index: 10000;
                animation: slideInRight 0.3s ease;
                box-shadow: 0 5px 20px rgba(0,0,0,0.2);
                display: flex;
                align-items: center;
                gap: 10px;
                max-width: 400px;
            `;
            
            const colores = {
                success: '#27ae60',
                error: '#e74c3c',
                warning: '#f39c12',
                info: '#3498db'
            };
            
            const iconos = {
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è',
                info: '‚ÑπÔ∏è'
            };
            
            notificacion.style.background = colores[tipo];
            notificacion.innerHTML = `${iconos[tipo]} ${mensaje}`;
            
            document.body.appendChild(notificacion);
            
            setTimeout(() => {
                notificacion.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    document.body.removeChild(notificacion);
                }, 300);
            }, 4000);
            
            if (!document.getElementById('notificacion-estilos')) {
                const estilos = document.createElement('style');
                estilos.id = 'notificacion-estilos';
                estilos.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(estilos);
            }
        }

        generarEnlaces(titulo, autor) {
            const query = `${titulo}`.trim();
            const queryAutor =` ${autor}`.trim();
            const queryEncoded = encodeURIComponent(query);
            const queryEncoded2 = encodeURIComponent(queryAutor);
            
            return {
                'Z-Library': `https://z-library.ec/s/${query.toLowerCase().replace(/\s+/g, '%20')}`,
                'LibGen': `https://libgen.bz/index.php?req=${queryEncoded}&columns%5B%5D=t&columns%5B%5D=a&columns%5B%5D=s&columns%5B%5D=y&columns%5B%5D=p&columns%5B%5D=i&objects%5B%5D=f&objects%5B%5D=e&objects%5B%5D=s&objects%5B%5D=a&objects%5B%5D=p&objects%5B%5D=w&topics%5B%5D=l&topics%5B%5D=c&topics%5B%5D=f&topics%5B%5D=a&topics%5B%5D=m&topics%5B%5D=r&topics%5B%5D=s&res=25&filesuns=all`,
                'audiobookbay': `https://audiobookbay.lu/?s=${queryEncoded}`,
                'YouTube': `https://www.youtube.com/results?search_query=${queryEncoded}+audiolibro`,
                'Internet Archive': `https://archive.org/search.php?query=${queryEncoded}+audio`,
                'Librivox': `https://librivox.org/search?q=${queryEncoded}`,
                'Google Books': `https://www.google.com/search?q=${queryEncoded}+libro`,



                'Z-Library por autor': `https://z-library.ec/s/${queryAutor.toLowerCase().replace(/\s+/g, '%20')}`,
                'LibGen por autor': `https://libgen.bz/index.php?req=${queryEncoded2}&columns%5B%5D=t&columns%5B%5D=a&columns%5B%5D=s&columns%5B%5D=y&columns%5B%5D=p&columns%5B%5D=i&objects%5B%5D=f&objects%5B%5D=e&objects%5B%5D=s&objects%5B%5D=a&objects%5B%5D=p&objects%5B%5D=w&topics%5B%5D=l&topics%5B%5D=c&topics%5B%5D=f&topics%5B%5D=a&topics%5B%5D=m&topics%5B%5D=r&topics%5B%5D=s&res=25&filesuns=all`,
                'audiobookbay por autor': `https://audiobookbay.lu/?s=${queryEncoded2}`,
                'YouTube por autor': `https://www.youtube.com/results?search_query=${queryEncoded2}+audiolibro`,
                'Internet Archive por autor': `https://archive.org/search.php?query=${queryEncoded2}+audio`,
                'Librivox por autor': `https://librivox.org/search?q=${queryEncoded2}`,
                'Google Books por autor': `https://www.google.com/search?q=${queryEncoded2}+libro`,
            };
        }

        analizarEnlace(plataforma, url) {
            let tipo = 'BUSQUEDA';
            let icono = 'üîó';
            let esDirecto = false;

            const plataformaLower = plataforma.toLowerCase();
            const urlLower = url.toLowerCase();

            if (urlLower.includes('audio') || urlLower.includes('audiolibro') || 
                plataformaLower.includes('audio')) {
                tipo = 'AUDIOLIBRO';
            }
            if (urlLower.includes('z-library') || urlLower.includes('libgen')) {
                tipo = 'DESCARGA';
            }
            if (urlLower.includes('youtube')) {
                tipo = 'VIDEO';
            }

            const iconos = {
                'Z-Library': 'üì•',
                'LibGen': 'üìö',
                'audiobookbay': 'üîä',
                'YouTube': 'üé•',
                'Internet Archive': 'üèõÔ∏è',
                'Librivox': 'üÜì',
                'Google Books': 'üîç',


                'Z-Library por autor': 'üì•',
                'LibGen por autor': 'üìö',
                'audiobookbay por autor': 'üîä',
                'YouTube por autor': 'üé•',
                'Internet Archive por autor': 'üèõÔ∏è',
                'Librivox por autor': 'üÜì',
                'Google Books por autor': 'üîç',
            };

            icono = iconos[plataforma] || 'üîó';

            return { tipo, icono, esDirecto };
        }

        esEducativo(titulo) {
            if (!titulo) return false;
            const palabrasEducativas = [
                'educaci√≥n', 'educativo', 'educativa', 'ense√±anza', 'pedagog√≠a',
                'did√°ctica', 'curso', 'manual', 'gu√≠a', 'aprendizaje', 'texto',
                'escolar', 'acad√©mico', 'universidad', 'aprende', 'ense√±a'
            ];
            const tituloLower = titulo.toLowerCase();
            return palabrasEducativas.some(palabra => tituloLower.includes(palabra));
        }

        filterBooks(filter) {
            this.filtroActivo = filter;
            
            const buttons = document.querySelectorAll('.filter-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // Marcar bot√≥n activo
            const activeBtn = Array.from(buttons).find(btn => 
                btn.textContent.toLowerCase().includes(filter) && !btn.classList.contains('tag-filter-btn')
            );
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Aplicar filtro combinado
            this.aplicarFiltrosActuales();
        }

        limpiarBusquedas() {
            if (this.libros.length === 0) {
                this.mostrarNotificacion('No hay b√∫squedas para limpiar', 'info');
                return;
            }

            const descargados = Object.keys(this.librosDescargados).length;
            const noEncontrados = Object.keys(this.librosNoEncontrados).length;
            const etiquetasPersonales = this.etiquetasPersonalizadas.length;
            const librosEtiquetados = Object.keys(this.librosEtiquetas).length;
            
            const mensaje = `¬øLimpiar ${this.libros.length} libros?\n\n` +
                `Incluye:\n` +
                `‚Ä¢ ${descargados} marcados como descargados\n` +
                `‚Ä¢ ${noEncontrados} marcados como no encontrados\n` +
                `‚Ä¢ ${etiquetasPersonales} etiquetas personalizadas\n` +
                `‚Ä¢ ${librosEtiquetados} libros con etiquetas\n\n` +
                `Esta acci√≥n no se puede deshacer.`;
            
            if (confirm(mensaje)) {
                this.libros = [];
                this.librosDescargados = {};
                this.librosNoEncontrados = {};
                this.etiquetasPersonalizadas = [];
                this.librosEtiquetas = {};
                this.borrarFiltros();
                this.actualizarEstadisticas();
                this.actualizarContadores();
                this.actualizarFiltrosEtiquetas();
                this.guardarDatos();
                
                this.mostrarNotificacion('Todos los datos han sido limpiados', 'success');
            }
        }
        
        exportarLista() {
            if (this.libros.length === 0) {
                this.mostrarNotificacion('No hay libros para exportar', 'warning');
                return;
            }

            let contenido = '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            contenido += '        LISTA DE AUDIOLIBROS BUSCADOS\n';
            contenido += '        (CON ETIQUETAS PERSONALIZADAS)\n';
            contenido += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
            contenido += `Fecha de exportaci√≥n: ${new Date().toLocaleDateString('es-ES', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            })}\n`;
            contenido += `Total de libros: ${this.libros.length}\n`;
            contenido += `Libros descargados: ${Object.keys(this.librosDescargados).length}\n`;
            contenido += `Libros no encontrados: ${Object.keys(this.librosNoEncontrados).length}\n`;
            contenido += `Etiquetas personalizadas: ${this.etiquetasPersonalizadas.length}\n`;
            contenido += `Libros etiquetados: ${Object.keys(this.librosEtiquetas).length}\n`;
            
            if (this.etiquetasPersonalizadas.length > 0) {
                contenido += '\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
                contenido += '            ETIQUETAS PERSONALIZADAS\n';
                contenido += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';
                
                this.etiquetasPersonalizadas.forEach((etiqueta, index) => {
                    const librosConEstaEtiqueta = Object.keys(this.librosEtiquetas).filter(
                        libroId => this.librosEtiquetas[libroId].id === etiqueta.id
                    ).length;
                    
                    contenido += `${index + 1}. [‚ñ†] ${etiqueta.nombre}\n`;
                    contenido += `   Color: ${etiqueta.color}\n`;
                    contenido += `   Usada en: ${librosConEstaEtiqueta} libro(s)\n\n`;
                });
            }
            
            contenido += '\n‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n';
            contenido += '                 LISTA DE LIBROS\n';
            contenido += '‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n';

            this.libros.forEach((libro, index) => {
                const esDescargado = this.librosDescargados[libro.id];
                const esNoEncontrado = this.librosNoEncontrados[libro.id];
                const etiqueta = this.librosEtiquetas[libro.id];
                
                contenido += `[${index + 1}] `;
                contenido += esDescargado ? '[‚úì DESCARGADO] ' : '';
                contenido += esNoEncontrado ? '[‚úó NO ENCONTRADO] ' : '';
                contenido += etiqueta ? `[üè∑Ô∏è ${etiqueta.nombre}] ` : '';
                contenido += '\n';
                
                contenido += `T√çTULO: ${libro.titulo}\n`;
                contenido += `AUTOR: ${libro.autor || 'Autor desconocido'}\n`;
                contenido += `FECHA: ${new Date(libro.fechaBusqueda || Date.now()).toLocaleDateString()}\n`;
                
                if (etiqueta) {
                    contenido += `ETIQUETA: ${etiqueta.nombre} (Color: ${etiqueta.color})\n`;
                }
                
                if (esNoEncontrado) {
                    contenido += `ESTADO: ‚úó NO ENCONTRADO EN NINGUNA PLATAFORMA\n\n`;
                } else {
                    contenido += `ENLACES (${libro.enlaces ? libro.enlaces.length : 0}):\n\n`;
                    
                    if (!libro.enlaces || libro.enlaces.length === 0) {
                        contenido += `  No se encontraron enlaces\n\n`;
                    } else {
                        libro.enlaces.forEach(enlace => {
                            contenido += `  ‚Ä¢ ${enlace.plataforma}: ${enlace.url}\n`;
                        });
                        contenido += '\n';
                    }
                }
                
                contenido += '‚îÄ'.repeat(55) + '\n\n';
            });

            const blob = new Blob([contenido], { type: 'text/plain;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fecha = new Date().toISOString().split('T')[0];
            a.download = `lista_audiolibros_${fecha}.txt`;
            a.click();
            URL.revokeObjectURL(url);
            
            this.mostrarNotificacion('Lista exportada con etiquetas personalizadas', 'success');
        }

        // NUEVO: M√âTODO PARA REGENERAR ENLACES DE TODOS LOS LIBROS
        regenerarEnlacesLibros() {
            if (this.libros.length === 0) {
                this.mostrarNotificacion('No hay libros en el historial', 'warning');
                return;
            }

            const totalLibros = this.libros.length;
            let regenerados = 0;
            let fallidos = 0;

            // Mostrar mensaje de confirmaci√≥n
            const mensajeConfirmacion = `¬øRegenerar enlaces para ${totalLibros} libros?\n\n` +
                `Esta operaci√≥n:\n` +
                `‚Ä¢ Buscar√° nuevamente cada libro en todas las plataformas\n` +
                `‚Ä¢ Preservar√° marcadores de descargado/no encontrado\n` +
                `‚Ä¢ Preservar√° etiquetas asignadas\n` +
                `‚Ä¢ Puede tardar varios minutos\n\n` +
                `¬øContinuar?`;

            if (!confirm(mensajeConfirmacion)) {
                return;
            }

            // Mostrar progreso
            const notificacionProgreso = document.createElement('div');
            notificacionProgreso.id = 'progress-notification';
            notificacionProgreso.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                padding: 20px;
                background: white;
                border-radius: 12px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.3);
                z-index: 10000;
                text-align: center;
                min-width: 300px;
                border: 2px solid var(--primary);
            `;
            notificacionProgreso.innerHTML = `
                <h3 style="margin: 0 0 15px 0; color: var(--primary);">üîÑ Regenerando Enlaces</h3>
                <div id="progress-text" style="margin-bottom: 10px;">Procesando libro 1 de ${totalLibros}...</div>
                <div style="background: var(--bg-color); border-radius: 10px; height: 20px; overflow: hidden;">
                    <div id="progress-bar" style="height: 100%; background: var(--primary); width: 0%; transition: width 0.3s;"></div>
                </div>
                <div id="progress-details" style="margin-top: 10px; font-size: 12px; color: var(--gray);"></div>
                <button id="cancel-regen" style="margin-top: 15px; padding: 8px 20px; background: var(--danger); color: white; border: none; border-radius: 20px; cursor: pointer;">
                    Cancelar
                </button>
            `;
            document.body.appendChild(notificacionProgreso);

            // Variable para cancelar
            let cancelarProceso = false;
            document.getElementById('cancel-regen').addEventListener('click', () => {
                cancelarProceso = true;
            });

            // Funci√≥n para procesar los libros en secuencia
            const procesarLibros = async () => {
                for (let i = 0; i < totalLibros && !cancelarProceso; i++) {
                    const libro = this.libros[i];
                    
                    // Actualizar progreso
                    document.getElementById('progress-text').textContent = 
                        `Procesando libro ${i + 1} de ${totalLibros}: ${libro.titulo.substring(0, 40)}...`;
                    document.getElementById('progress-bar').style.width = 
                        `${((i + 1) / totalLibros) * 100}%`;
                    document.getElementById('progress-details').innerHTML = 
                        `Regenerados: ${regenerados} | Fallidos: ${fallidos}`;

                    // Preservar marcadores
                    const marcadoresPreservados = {
                        descargado: this.librosDescargados[libro.id],
                        noEncontrado: this.librosNoEncontrados[libro.id],
                        etiqueta: this.librosEtiquetas[libro.id]
                    };

                    try {
                        // Buscar el libro nuevamente (b√∫squeda completa)
                        const todosEnlaces = this.generarEnlaces(libro.titulo, libro.autor);
                        const enlacesActualizados = [];
                        
                        Object.entries(todosEnlaces).forEach(([plataforma, url]) => {
                            const analisis = this.analizarEnlace(plataforma, url);
                            
                            enlacesActualizados.push({
                                plataforma: plataforma,
                                url: url,
                                tipo: analisis.tipo,
                                icono: analisis.icono,
                                esDirecto: analisis.esDirecto
                            });
                        });

                        // Actualizar el libro
                        const libroActualizado = {
                            ...libro,
                            enlaces: enlacesActualizados,
                            fechaBusqueda: new Date().toISOString(),
                            timestamp: Date.now()
                        };

                        // Reemplazar en el array
                        this.libros[i] = libroActualizado;

                        // Restaurar marcadores con el nuevo ID (por si cambi√≥)
                        if (marcadoresPreservados.descargado) {
                            this.librosDescargados[libroActualizado.id] = marcadoresPreservados.descargado;
                        }
                        if (marcadoresPreservados.noEncontrado) {
                            this.librosNoEncontrados[libroActualizado.id] = marcadoresPreservados.noEncontrado;
                        }
                        if (marcadoresPreservados.etiqueta) {
                            this.librosEtiquetas[libroActualizado.id] = marcadoresPreservados.etiqueta;
                        }

                        // Actualizar contador de no encontrados si no hay enlaces
                        if (enlacesActualizados.length === 0) {
                            this.librosNoEncontrados[libroActualizado.id] = {
                                fecha: new Date().toISOString(),
                                razon: 'Regeneraci√≥n: No se encontraron enlaces v√°lidos'
                            };
                            delete this.librosDescargados[libroActualizado.id];
                            fallidos++;
                        } else {
                            // Solo eliminar el marcador de no encontrado si ahora hay enlaces
                            if (this.librosNoEncontrados[libroActualizado.id] && 
                                this.librosNoEncontrados[libroActualizado.id].razon?.includes('Regeneraci√≥n')) {
                                delete this.librosNoEncontrados[libroActualizado.id];
                            }
                            regenerados++;
                        }

                        // Pausa para no sobrecargar las APIs
                        await new Promise(resolve => setTimeout(resolve, 300));

                    } catch (error) {
                        console.error(`Error regenerando ${libro.titulo}:`, error);
                        fallidos++;
                        
                        // Preservar el estado original en caso de error
                        if (marcadoresPreservados.descargado) {
                            this.librosDescargados[libro.id] = marcadoresPreservados.descargado;
                        }
                        if (marcadoresPreservados.noEncontrado) {
                            this.librosNoEncontrados[libro.id] = marcadoresPreservados.noEncontrado;
                        }
                        if (marcadoresPreservados.etiqueta) {
                            this.librosEtiquetas[libro.id] = marcadoresPreservados.etiqueta;
                        }
                    }
                }

                // Finalizar proceso
                if (cancelarProceso) {
                    this.mostrarNotificacion('Regeneraci√≥n cancelada por el usuario', 'info');
                } else {
                    // Guardar todos los cambios
                    this.guardarDatos();
                    
                    // Actualizar interfaz
                    this.mostrarLibros();
                    this.actualizarEstadisticas();
                    this.actualizarContadores();
                    
                    // Mostrar resumen
                    const mensajeResumen = `Regeneraci√≥n completada:\n\n` +
                        `‚úÖ ${regenerados} libros actualizados\n` +
                        `‚ùå ${fallidos} libros con errores\n\n` +
                        `Los marcadores y etiquetas se han preservado.`;
                    
                    this.mostrarNotificacion(mensajeResumen, 'success');
                }

                // Eliminar ventana de progreso
                if (document.getElementById('progress-notification')) {
                    document.body.removeChild(notificacionProgreso);
                }
            };

            // Iniciar procesamiento
            procesarLibros();
        }
    }

    // Variables globales
    let buscador;

    // Funci√≥n global para borrar filtros
    function borrarFiltros() {
        buscador.borrarFiltros();
    }

    // Funciones globales para el gestor de etiquetas
    function mostrarGestorEtiquetas() {
        buscador.mostrarGestorEtiquetas();
    }

    function ocultarGestorEtiquetas() {
        buscador.ocultarGestorEtiquetas();
    }

    function crearNuevaEtiqueta() {
        const nombre = document.getElementById('newTagName').value;
        const color = document.getElementById('colorPicker').value;
        
        const nuevaEtiqueta = buscador.crearEtiquetaPersonalizada(nombre, color);
        if (nuevaEtiqueta) {
            document.getElementById('newTagName').value = '';
            buscador.actualizarListaEtiquetasPersonalizadas();
        }
    }

    // Funci√≥n para filtrar por etiquetas
    function filterByTag(etiquetaId) {
        buscador.filtrarLibrosPorEtiqueta(etiquetaId);
    }

    // Funciones para regenerar enlaces
    function regenerarTodosLosEnlaces() {
        buscador.regenerarEnlacesLibros();
    }

    function regenerarEnlaceIndividual(libroId) {
        buscador.regenerarEnlacesLibro(libroId);
    }

    // Funciones globales restantes
    function mostrarBusquedaManual() {
        document.getElementById('busquedaManualPanel').classList.remove('hidden');
        document.querySelectorAll('.method-btn').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }

    function buscarLibroManual() {
        const titulo = document.getElementById('tituloInput').value;
        const autor = document.getElementById('autorInput').value;
        buscador.buscarLibro(titulo, autor);
    }

    function busquedaRapida(tipo) {
        const titulo = document.getElementById('tituloInput').value;
        const autor = document.getElementById('autorInput').value;
        if (!titulo.trim()) {
            buscador.mostrarNotificacion('Por favor ingresa al menos el t√≠tulo del libro', 'warning');
            document.getElementById('tituloInput').focus();
            return;
        }
        buscador.buscarLibro(titulo, autor, tipo);
    }

    function filterBooks(filter) {
        buscador.filterBooks(filter);
    }

    function exportarLista() {
        buscador.exportarLista();
    }

    function exportarDatosCompletos() {
        buscador.exportarDatosCompletos();
    }

    function importarDatos() {
        buscador.importarDatos();
    }

    function limpiarBusquedas() {
        buscador.limpiarBusquedas();
    }

    // Inicializaci√≥n
    document.addEventListener('DOMContentLoaded', function() {
        buscador = new BuscadorAudiolibros();
        
        // Eventos de teclado para b√∫squeda
        document.getElementById('tituloInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarLibroManual();
            }
        });
        
        document.getElementById('autorInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                buscarLibroManual();
            }
        });
        
        // Auto-focus en el campo de t√≠tulo
        document.getElementById('tituloInput').focus();
    });

    // Mejorar rendimiento en dispositivos m√≥viles
    if ('ontouchstart' in window) {
        document.documentElement.style.touchAction = 'manipulation';
        document.documentElement.style.webkitTapHighlightColor = 'transparent';
    }
</script>

</body>
</html>